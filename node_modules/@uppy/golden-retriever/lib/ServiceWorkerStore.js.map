{"version":3,"names":["isSupported","navigator","waitForServiceWorker","Promise","resolve","reject","Error","serviceWorker","controller","addEventListener","_ready","_classPrivateFieldLooseKey","ServiceWorkerStore","constructor","opts","Object","defineProperty","writable","value","_classPrivateFieldLooseBase","then","val","name","storeName","ready","list","onMessage","event","data","store","type","files","removeEventListener","postMessage","put","file","delete","fileID"],"sources":["ServiceWorkerStore.ts"],"sourcesContent":["import type { Body, Meta, UppyFile } from '@uppy/utils/lib/UppyFile'\n\nconst isSupported =\n  typeof navigator !== 'undefined' && 'serviceWorker' in navigator\n\nfunction waitForServiceWorker() {\n  return new Promise<void>((resolve, reject) => {\n    if (!isSupported) {\n      reject(new Error('Unsupported'))\n    } else if (navigator.serviceWorker.controller) {\n      // A serviceWorker is already registered and active.\n      resolve()\n    } else {\n      navigator.serviceWorker.addEventListener('controllerchange', () => {\n        resolve()\n      })\n    }\n  })\n}\n\nexport type ServiceWorkerStoredFile<M extends Meta, B extends Body> = {\n  type: string\n  store: string\n  file: UppyFile<M, B>\n}\n\ntype ServiceWorkerStoreOptions = {\n  storeName: string\n}\n\nclass ServiceWorkerStore<M extends Meta, B extends Body> {\n  #ready: void | Promise<void>\n\n  name: string\n\n  static isSupported: boolean\n\n  constructor(opts: ServiceWorkerStoreOptions) {\n    this.#ready = waitForServiceWorker().then((val) => {\n      this.#ready = val\n    })\n    this.name = opts.storeName\n  }\n\n  get ready(): Promise<void> {\n    return Promise.resolve(this.#ready)\n  }\n\n  async list(): Promise<ServiceWorkerStoredFile<M, B>[]> {\n    await this.#ready\n\n    return new Promise((resolve, reject) => {\n      const onMessage = (event: MessageEvent) => {\n        if (event.data.store !== this.name) {\n          return\n        }\n        switch (event.data.type) {\n          case 'uppy/ALL_FILES':\n            resolve(event.data.files)\n            navigator.serviceWorker.removeEventListener('message', onMessage)\n            break\n          default:\n            reject()\n        }\n      }\n\n      navigator.serviceWorker.addEventListener('message', onMessage)\n\n      navigator.serviceWorker.controller!.postMessage({\n        type: 'uppy/GET_FILES',\n        store: this.name,\n      })\n    })\n  }\n\n  async put(file: UppyFile<any, any>): Promise<void> {\n    await this.#ready\n    navigator.serviceWorker.controller!.postMessage({\n      type: 'uppy/ADD_FILE',\n      store: this.name,\n      file,\n    })\n  }\n\n  async delete(fileID: string): Promise<void> {\n    await this.#ready\n    navigator.serviceWorker.controller!.postMessage({\n      type: 'uppy/REMOVE_FILE',\n      store: this.name,\n      fileID,\n    })\n  }\n}\n\nServiceWorkerStore.isSupported = isSupported\n\nexport default ServiceWorkerStore\n"],"mappings":"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","ignoreList":[]}