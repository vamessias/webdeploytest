{"version":3,"names":["BasePlugin","findDOMElement","toArray","getFormData","packageJson","defaultOptions","resultName","getMetaFromForm","addResultToForm","submitOnSuccess","triggerUploadOnSubmit","assertHTMLFormElement","input","nodeName","Error","cause","_form","_classPrivateFieldLooseKey","Form","constructor","uppy","opts","Object","defineProperty","writable","value","type","id","handleFormSubmit","bind","handleUploadStart","handleSuccess","result","_classPrivateFieldLooseBase","reportValidity","submit","ev","preventDefault","elements","target","disabledByUppy","forEach","el","isButton","tagName","disabled","push","upload","then","button","err","Promise","reject","catch","log","stack","message","resultInput","querySelector","updatedResult","JSON","parse","Array","isArray","stringify","document","createElement","name","appendChild","formMeta","setMeta","install","addEventListener","on","uninstall","removeEventListener","off","VERSION","version"],"sources":["index.ts"],"sourcesContent":["import BasePlugin, { type DefinePluginOpts } from '@uppy/core/lib/BasePlugin.js'\nimport findDOMElement from '@uppy/utils/lib/findDOMElement'\nimport toArray from '@uppy/utils/lib/toArray'\n\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore untyped\nimport getFormData from 'get-form-data'\n\nimport type { UIPluginOptions, Uppy, UppyEventMap } from '@uppy/core'\nimport type { Body, Meta } from '@uppy/utils/lib/UppyFile'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore We don't want TS to generate types for the package.json\nimport packageJson from '../package.json'\n\ntype Result<M extends Meta, B extends Body> = Parameters<\n  UppyEventMap<M, B>['complete']\n>[0]\n\nexport interface FormOptions extends UIPluginOptions {\n  resultName?: string\n  getMetaFromForm?: boolean\n  addResultToForm?: boolean\n  submitOnSuccess?: boolean\n  triggerUploadOnSubmit?: boolean\n}\n\nconst defaultOptions = {\n  resultName: 'uppyResult',\n  getMetaFromForm: true,\n  addResultToForm: true,\n  submitOnSuccess: false,\n  triggerUploadOnSubmit: false,\n}\n\ntype Opts = DefinePluginOpts<FormOptions, keyof typeof defaultOptions>\n\nfunction assertHTMLFormElement(input: Node | null): HTMLFormElement {\n  if (input == null || input.nodeName !== 'FORM') {\n    throw new Error('ASSERTION FAILED: the target is not a <form> element', {\n      cause: input,\n    })\n  }\n  return input as any\n}\n\nexport default class Form<M extends Meta, B extends Body> extends BasePlugin<\n  Opts,\n  M,\n  B\n> {\n  static VERSION = packageJson.version\n\n  #form!: HTMLFormElement\n\n  constructor(uppy: Uppy<M, B>, opts?: FormOptions) {\n    super(uppy, { ...defaultOptions, ...opts })\n    this.type = 'acquirer'\n    this.id = this.opts.id || 'Form'\n\n    this.handleFormSubmit = this.handleFormSubmit.bind(this)\n    this.handleUploadStart = this.handleUploadStart.bind(this)\n    this.handleSuccess = this.handleSuccess.bind(this)\n    this.addResultToForm = this.addResultToForm.bind(this)\n    this.getMetaFromForm = this.getMetaFromForm.bind(this)\n  }\n\n  handleUploadStart(): void {\n    if (this.opts.getMetaFromForm) {\n      this.getMetaFromForm()\n    }\n  }\n\n  handleSuccess(result: Result<M, B>): void {\n    if (this.opts.addResultToForm) {\n      this.addResultToForm(result)\n    }\n\n    if (this.opts.submitOnSuccess) {\n      // Returns true if the element's child controls satisfy their validation constraints.\n      // When false is returned, cancelable invalid events are fired for each invalid child\n      // and validation problems are reported to the user.\n      if (this.#form.reportValidity()) {\n        this.#form.submit()\n      }\n    }\n  }\n\n  handleFormSubmit(ev: Event): void {\n    if (this.opts.triggerUploadOnSubmit) {\n      ev.preventDefault()\n      const elements = toArray((ev.target as HTMLFormElement).elements)\n      const disabledByUppy: HTMLButtonElement[] = []\n      elements.forEach((el) => {\n        const isButton =\n          el.tagName === 'BUTTON' ||\n          (el.tagName === 'INPUT' &&\n            (el as HTMLButtonElement).type === 'submit')\n        if (isButton && !(el as HTMLButtonElement).disabled) {\n          ;(el as HTMLButtonElement).disabled = true // eslint-disable-line no-param-reassign\n          disabledByUppy.push(el as HTMLButtonElement)\n        }\n      })\n      this.uppy\n        .upload()\n        .then(\n          () => {\n            disabledByUppy.forEach((button) => {\n              button.disabled = false // eslint-disable-line no-param-reassign\n            })\n          },\n          (err) => {\n            disabledByUppy.forEach((button) => {\n              button.disabled = false // eslint-disable-line no-param-reassign\n            })\n            return Promise.reject(err)\n          },\n        )\n        .catch((err) => {\n          this.uppy.log(err.stack || err.message || err)\n        })\n    }\n  }\n\n  addResultToForm(result: Result<M, B>): void {\n    this.uppy.log('[Form] Adding result to the original form:')\n    this.uppy.log(result)\n\n    let resultInput: HTMLInputElement | null = this.#form.querySelector(\n      `[name=\"${this.opts.resultName}\"]`,\n    )\n    if (resultInput) {\n      // Append new result to the previous result array.\n      // If the previous result is empty, or not an array,\n      // set it to an empty array.\n      let updatedResult\n      try {\n        updatedResult = JSON.parse(resultInput.value)\n      } catch (err) {\n        // Nothing, since we check for array below anyway\n      }\n\n      if (!Array.isArray(updatedResult)) {\n        updatedResult = []\n      }\n      updatedResult.push(result)\n      resultInput.value = JSON.stringify(updatedResult)\n      return\n    }\n\n    resultInput = document.createElement('input')\n    resultInput.name = this.opts.resultName\n    resultInput.type = 'hidden'\n    resultInput.value = JSON.stringify([result])\n\n    this.#form.appendChild(resultInput)\n  }\n\n  getMetaFromForm(): void {\n    const formMeta = getFormData(this.#form)\n    // We want to exclude meta the the Form plugin itself has added\n    // See https://github.com/transloadit/uppy/issues/1637\n    delete formMeta[this.opts.resultName]\n    this.uppy.setMeta(formMeta)\n  }\n\n  install(): void {\n    this.#form = assertHTMLFormElement(findDOMElement(this.opts.target))\n\n    this.#form.addEventListener('submit', this.handleFormSubmit)\n    this.uppy.on('upload', this.handleUploadStart)\n    this.uppy.on('complete', this.handleSuccess)\n  }\n\n  uninstall(): void {\n    this.#form.removeEventListener('submit', this.handleFormSubmit)\n    this.uppy.off('upload', this.handleUploadStart)\n    this.uppy.off('complete', this.handleSuccess)\n  }\n}\n"],"mappings":"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","ignoreList":[]}