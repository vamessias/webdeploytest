{"version":3,"names":["BasePlugin","RateLimitedQueue","getFileNameAndExtension","prettierBytes","CompressorJS","locale","defaultOptions","quality","limit","_RateLimitedQueue","_classPrivateFieldLooseKey","Compressor","constructor","uppy","opts","Object","defineProperty","writable","value","id","type","defaultLocale","_classPrivateFieldLooseBase","i18nInit","prepareUpload","bind","compress","blob","Promise","resolve","reject","success","error","fileIDs","totalCompressedSize","compressedFiles","compressAndApplyResult","wrapPromiseFunction","file","compressedBlob","data","compressedSavingsSize","size","log","name","compressedFileName","metaFileName","meta","newMetaName","extension","setFileState","push","err","promises","map","fileID","_file$type","getFile","emit","mode","message","i18n","isRemote","slice","startsWith","all","info","install","addPreProcessor","uninstall","removePreProcessor"],"sources":["index.ts"],"sourcesContent":["import { BasePlugin, Uppy } from '@uppy/core'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport { RateLimitedQueue } from '@uppy/utils/lib/RateLimitedQueue'\nimport getFileNameAndExtension from '@uppy/utils/lib/getFileNameAndExtension'\nimport prettierBytes from '@transloadit/prettier-bytes'\nimport CompressorJS from 'compressorjs'\n\nimport type { Body, Meta, UppyFile } from '@uppy/utils/lib/UppyFile'\nimport type { DefinePluginOpts, PluginOpts } from '@uppy/core/lib/BasePlugin.js'\n\nimport locale from './locale.ts'\n\ndeclare module '@uppy/core' {\n  export interface UppyEventMap<M extends Meta, B extends Body> {\n    'compressor:complete': (file: UppyFile<M, B>[]) => void\n  }\n}\n\nexport interface CompressorOpts extends PluginOpts, CompressorJS.Options {\n  limit?: number\n}\n\nexport type { CompressorOpts as CompressorOptions }\n\nconst defaultOptions = {\n  quality: 0.6,\n  limit: 10,\n} satisfies Partial<CompressorOpts>\n\nexport default class Compressor<\n  M extends Meta,\n  B extends Body,\n> extends BasePlugin<\n  DefinePluginOpts<CompressorOpts, keyof typeof defaultOptions>,\n  M,\n  B\n> {\n  #RateLimitedQueue\n\n  constructor(uppy: Uppy<M, B>, opts?: CompressorOpts) {\n    super(uppy, { ...defaultOptions, ...opts })\n    this.id = this.opts.id || 'Compressor'\n    this.type = 'modifier'\n\n    this.defaultLocale = locale\n\n    this.#RateLimitedQueue = new RateLimitedQueue(this.opts.limit)\n\n    this.i18nInit()\n\n    this.prepareUpload = this.prepareUpload.bind(this)\n    this.compress = this.compress.bind(this)\n  }\n\n  compress(blob: Blob): Promise<Blob | File> {\n    return new Promise((resolve, reject) => {\n      /* eslint-disable no-new */\n      new CompressorJS(blob, {\n        ...this.opts,\n        success: resolve,\n        error: reject,\n      })\n    })\n  }\n\n  async prepareUpload(fileIDs: string[]): Promise<void> {\n    let totalCompressedSize = 0\n    const compressedFiles: UppyFile<M, B>[] = []\n    const compressAndApplyResult = this.#RateLimitedQueue.wrapPromiseFunction(\n      async (file: UppyFile<M, B>) => {\n        try {\n          const compressedBlob = await this.compress(file.data)\n          const compressedSavingsSize = file.data.size - compressedBlob.size\n          this.uppy.log(\n            `[Image Compressor] Image ${file.id} compressed by ${prettierBytes(compressedSavingsSize)}`,\n          )\n          totalCompressedSize += compressedSavingsSize\n          const { name, type, size } = compressedBlob as File\n\n          const compressedFileName = getFileNameAndExtension(name)\n          const metaFileName = getFileNameAndExtension(file.meta.name)\n\n          // Name (file.meta.name) might have been changed by user, so we update only the extension\n          const newMetaName = `${metaFileName.name}.${compressedFileName.extension}`\n\n          this.uppy.setFileState(file.id, {\n            ...(name && { name }),\n            ...(compressedFileName.extension && {\n              extension: compressedFileName.extension,\n            }),\n            ...(type && { type }),\n            ...(size && { size }),\n            data: compressedBlob,\n            meta: {\n              ...file.meta,\n              type,\n              name: newMetaName,\n            },\n          })\n          compressedFiles.push(file)\n        } catch (err) {\n          this.uppy.log(\n            `[Image Compressor] Failed to compress ${file.id}:`,\n            'warning',\n          )\n          this.uppy.log(err, 'warning')\n        }\n      },\n    )\n\n    const promises = fileIDs.map((fileID) => {\n      const file = this.uppy.getFile(fileID)\n      this.uppy.emit('preprocess-progress', file, {\n        mode: 'indeterminate',\n        message: this.i18n('compressingImages'),\n      })\n\n      if (file.isRemote) {\n        return Promise.resolve()\n      }\n\n      // Some browsers (Firefox) add blobs with empty file type, when files are\n      // added from a folder. Uppy auto-detects type from extension, but leaves the original blob intact.\n      // However, Compressor.js failes when file has no type, so we set it here\n      if (!file.data.type) {\n        file.data = file.data.slice(0, file.data.size, file.type)\n      }\n\n      if (!file.type?.startsWith('image/')) {\n        return Promise.resolve()\n      }\n\n      return compressAndApplyResult(file)\n    })\n\n    // Why emit `preprocess-complete` for all files at once, instead of\n    // above when each is processed?\n    // Because it leads to StatusBar showing a weird “upload 6 files” button,\n    // while waiting for all the files to complete pre-processing.\n    await Promise.all(promises)\n\n    this.uppy.emit('compressor:complete', compressedFiles)\n\n    // Only show informer if Compressor mananged to save at least a kilobyte\n    if (totalCompressedSize > 1024) {\n      this.uppy.info(\n        this.i18n('compressedX', {\n          size: prettierBytes(totalCompressedSize),\n        }),\n        'info',\n      )\n    }\n\n    for (const fileID of fileIDs) {\n      const file = this.uppy.getFile(fileID)\n      this.uppy.emit('preprocess-complete', file)\n    }\n  }\n\n  install(): void {\n    this.uppy.addPreProcessor(this.prepareUpload)\n  }\n\n  uninstall(): void {\n    this.uppy.removePreProcessor(this.prepareUpload)\n  }\n}\n"],"mappings":"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","ignoreList":[]}